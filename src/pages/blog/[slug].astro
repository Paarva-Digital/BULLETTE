---
import Layout from "@/layouts/Layout.astro";
import { sanity } from "@/sanity/lib/sanity";
import { PortableText } from "astro-portabletext";
import Navbar from "@/components/Global/Navbar.astro";
import Footer from "@/components/Global/Footer.astro";

export const prerender = false;

const { slug } = Astro.params;

const post = await sanity.fetch(
  `
  *[_type == "blogPost" && slug.current == $slug][0]{
    title,
    excerpt,
    content,        // ✅ FIXED
    author,
    publishedAt,
    coverImage{
      asset->{url}
    }
  }
  `,
  { slug }
);


const relatedPosts = await sanity.fetch(
  `
  *[_type == "blogPost" && slug.current != $slug]
  | order(publishedAt desc)[0..2]{
    title,
    "slug": slug.current,
    excerpt,
    publishedAt,
    coverImage{
      asset->{url}
    }
  }
  `,
  { slug }
);

---
<Layout>
  <Navbar />

  <!-- Exclude blog article content from Pagefind index -->
  <article data-pagefind-ignore class="bg-white py-24 sm:py-40">
    <div class="container mx-auto px-6">

      <!-- GRID -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-14">

        <!-- ================= LEFT : BLOG CONTENT ================= -->
        <main class="lg:col-span-8">

          <h1 class="text-3xl sm:text-4xl font-semibold text-gray-900">
            {post.title}
          </h1>

          <div class="flex gap-4 text-sm text-gray-500 mt-3">
            <span>{post.author}</span>
            <span>•</span>
            <span>
              {new Date(post.publishedAt).toLocaleDateString("en-IN", {
                day: "2-digit",
                month: "short",
                year: "numeric",
              })}
            </span>
          </div>

          {post.coverImage?.asset?.url && (
            <img
              src={post.coverImage.asset.url}
              alt={post.title}
              class="w-full rounded-3xl mt-10 mb-10 object-cover"
            />
          )}

          <div
  class="
    text-base sm:text-lg lg:text-xl
    leading-relaxed lg:leading-loose
    text-gray-800

    [&>p]:mb-4
    [&>p]:max-w-full

    [&>p+p]:mt-4

    [&>h2]:text-2xl sm:[&>h2]:text-3xl
    [&>h2]:font-light
    [&>h2]:mt-12
    [&>h2]:mb-4
    [&>h2]:max-w-3xl

    [&>h3]:text-xl sm:[&>h3]:text-2xl
    [&>h3]:font-light
    [&>h3]:mt-10
    [&>h3]:mb-3
    [&>h3]:max-w-3xl

    [&>ul]:list-disc
    [&>ul]:pl-6
    [&>ul]:mb-4
    [&>ul]:max-w-3xl

    [&>ol]:list-decimal
    [&>ol]:pl-6
    [&>ol]:mb-4
    [&>ol]:max-w-3xl

    [&>li]:mb-1

    [&>blockquote]:border-l-4
    [&>blockquote]:border-red-600
    [&>blockquote]:pl-6
    [&>blockquote]:italic
    [&>blockquote]:text-gray-600
    [&>blockquote]:my-6
    [&>blockquote]:max-w-3xl

    [&>strong]:font-semibold
  "
>
  <PortableText value={post.content} />
</div>



        </main>

        <!-- ================= RIGHT : ASIDE ================= -->
        {relatedPosts?.length > 0 && (
          <aside class="lg:col-span-4">
            <div class="sticky top-32">

              <h3 class="text-lg font-medium text-gray-900 mb-6">
                More Articles
              </h3>

              <ul class="space-y-6">
  {relatedPosts.map((item) => (
    <li class="group">
      <a
        href={`/blog/${item.slug}`}
        class="flex gap-4 items-start"
      >
        <!-- Thumbnail -->
        <div class="w-16 h-16 flex-shrink-0 overflow-hidden rounded-xl bg-gray-100">
          <img
            src={item.coverImage?.asset?.url ?? "/images/placeholder.png"}
            alt={item.title}
            class="w-full h-full object-cover
                   group-hover:scale-105 transition duration-300"
          />
        </div>

        <!-- Text -->
        <div class="flex-1">
          <h4
            class="text-sm font-medium text-gray-900
                   group-hover:text-red-600 transition line-clamp-2"
          >
            {item.title}
          </h4>

          <span class="block text-xs text-gray-400 mt-1">
            {new Date(item.publishedAt).toLocaleDateString("en-IN", {
              day: "2-digit",
              month: "short",
              year: "numeric",
            })}
          </span>
        </div>
      </a>
    </li>
  ))}
</ul>


              <a
                href="/blog"
                class="inline-block mt-8 text-sm font-medium
                       text-red-600 hover:underline"
              >
                View all articles →
              </a>

            </div>
          </aside>
        )}

      </div>
    </div>
  </article>

  <Footer />
</Layout>


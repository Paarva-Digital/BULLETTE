---
import Layout from "../../../layouts/Layout.astro";
import Navbar from "../../../components/Global/Navbar.astro";
import ProductInquiryForm from "@/components/Products/ProductInquiryForm.astro";
import ProductExtendedDetails from "@/components/Products/ProductExtendedDetails.astro";
import ProductShare from "@/components/Products/ProductShare.astro";
import Footer from "@/components/Global/Footer.astro";
import { sanity } from "@/sanity/lib/sanity";

export const prerender = true;

export async function getStaticPaths() {
  type ProductPath = {
    slug: string;
    category: string;
  };

  const products = await sanity.fetch<ProductPath[]>(`
    *[_type == "product"]{
      "slug": slug.current,
      category
    }
  `);

  return products.map((product: ProductPath) => ({
    params: {
      category: product.category,
      slug: product.slug
    }
  }));
}

const { category, slug } = Astro.params;

type Product = {
  _id: string;
  name: string;
  slug: string;
  category: string;
  tag?: string;
  shortDescription?: string;
  description?: string;
  overview?: string;
  technical?: string[];
  applications?: string[];
  standards?: string[];
  image?: string;
  features?: string[];
  images?: { asset: { url: string }; alt?: string }[];
  specs?: Record<string, string>;
  pdf?: string;
};

const product = await sanity.fetch<Product>(
  `
  *[_type == "product" && slug.current == $slug][0]{
    _id,
    name,
    "slug": slug.current,
    category,
    tag,
    shortDescription,
    description,

    overview,
    technical,
    applications,
    standards,

    "image": image.asset->url,
    images[]{
      asset->{url},
      alt
    }
  }
  `,
  { slug }
);

// ---- Extended fallback logic (unchanged) ----
type ExtendedDetails = {
  overview: string;
  technical: string[];
  applications: string[];
  standards: string[];
};

let extendedDetails: ExtendedDetails = {
  overview: "",
  technical: [],
  applications: [],
  standards: [],
};

try {
  const module = await import(
    `../../../data/product-details/${slug}.js`
  );
  extendedDetails = module.default;
} catch {
  console.warn(`No extended details found for: ${slug}`);
}

const finalExtendedDetails: ExtendedDetails = {
  overview: product.overview || extendedDetails.overview,
  technical: product.technical?.length
    ? product.technical
    : extendedDetails.technical,
  applications: product.applications?.length
    ? product.applications
    : extendedDetails.applications,
  standards: product.standards?.length
    ? product.standards
    : extendedDetails.standards,
};
---



<Layout>
  <Navbar />

  <main
  data-pagefind-body
  data-pagefind-meta-name={product.name}
  data-pagefind-meta-category={product.category}
  class=" container px-3 mx-auto pt-24 sm:pt-40">
    {product ? (
      <section class="container mx-auto px-4 pb-16">

        <!-- Breadcrumb -->
        <nav aria-label="Breadcrumb" class="mb-4 sm:mb-10">
  <ol class="flex flex-wrap items-center gap-2
             text-sm xl:text-lg text-gray-500">

    <!-- Home -->
    <li>
      <a href="/"
         class="hover:text-red-600 transition">
        Home
      </a>
    </li>

    <li class="text-gray-400">/</li>

    <!-- Category -->
    <li>
      <a
        href={`/products/${category}`}
        class="capitalize font-medium text-gray-700
               hover:text-red-600 transition"
      >
        {category.replace(/-/g, " ")}
      </a>
    </li>

    <li class="text-gray-400">/</li>

    <!-- Product (current page) -->
    <li
      class="font-medium text-black"
      aria-current="page"
    >
      {product.name}
    </li>

  </ol>
</nav>





        <!-- GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-20 items-start">

          <!-- GALLERY -->
          <div class="space-y-4 sm:space-y-5">

            <!-- MAIN IMAGE -->
            <div
              class="relative aspect-square w-full bg-gray-100 rounded-2xl sm:rounded-3xl
                     overflow-hidden flex items-center justify-center"
            >
              <img
                id="mainImage"
                src={
  product.image ??
  product.images?.[0]?.asset?.url ??
  "/images/placeholder.png"
}

                alt={product.name}
                data-pagefind-meta="image[src],image_alt[alt]"
                class="w-full h-full object-contain transition-opacity duration-300"
              />
            </div>

            <!-- THUMBNAILS -->
            {product?.images?.length > 1 && (
              <div class="flex gap-3 overflow-x-auto pb-2 -mx-1 px-1">
                {product.images.map((img: { asset: { url: string }; alt?: string }, index: number) => (
                  <button
                    class="thumb shrink-0 aspect-square w-20 sm:w-24
                           rounded-xl sm:rounded-2xl overflow-hidden
                           border border-gray-200 hover:border-black transition"
                    data-img={img.asset.url}
                  >
                    <img
                      src={img.asset.url}
                      alt={img.alt ?? `${product.name} view ${index + 1}`}
                      class="w-full h-full object-contain"
                      loading="lazy"
                    />
                  </button>
                ))}
              </div>
            )}
          </div>

          <!-- CONTENT -->
          <div class="max-w-3xl">

            <h1 class="text-2xl sm:text-3xl md:text-4xl font-semibold text-black leading-tight">
              {product.name}
            </h1>

            <div class="mt-3 sm:mt-4 w-3/5 sm:w-1/3 h-1 bg-[#ef1923] rounded-full"></div>
{product?.shortDescription && (
  <p class="mt-4 text-base sm:text-xl text-gray-800 font-medium">
    {product.shortDescription}
  </p>
)}

{product?.description && (
  <p class="mt-4 text-sm sm:text-base text-gray-700 leading-relaxed">
    {product.description}
  </p>
)}


            {product?.features?.length && (
              <ul class="mt-5 sm:mt-6 space-y-2 text-sm sm:text-base text-gray-700 list-disc list-inside">
                {product.features.map((f: string) => (
                  <li>{f}</li>
                ))}
              </ul>
            )}

            <!-- SPECS -->
            {product?.specs && (
              <div class="mt-10 sm:mt-12">
                <h2 class="text-lg sm:text-xl font-semibold text-black mb-4 sm:mb-5">
                  Specifications
                </h2>

                <div class="rounded-xl sm:rounded-2xl border overflow-hidden">
                  {Object.entries(product.specs).map(([key, value]) => (
                    <div
                      class="flex flex-col sm:flex-row sm:justify-between
                             gap-1 sm:gap-6 px-4 sm:px-6 py-3 sm:py-4
                             text-sm odd:bg-gray-50"
                    >
                      <span class="text-gray-500">{key}</span>
                      <span class="font-medium text-black sm:text-right">
                        {value}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
                        <div class="mt-6">
              <ProductShare
                productName={product.name}
                productUrl={Astro.url.toString()}
              />
            </div>
            <!-- CTA -->
            <div class="mt-8 flex flex-col sm:flex-row gap-3 sm:gap-4">
              <a href="#inquiryForm"
                class="w-full sm:w-auto px-7 py-3 rounded-xl bg-black text-white
                       hover:bg-gray-900 transition font-medium text-center"
              >
                Enquire Now
              </a>

              {product.pdf ? (
  <a
    href={product.pdf}
    download
    target="_blank"
    rel="noopener"
    class="w-full sm:w-auto px-7 py-3 rounded-xl
           border border-gray-300 font-medium
           hover:border-black transition
           text-center"
  >
    Download PDF
  </a>
) : (
  <button
    disabled
    class="w-full sm:w-auto px-7 py-3 rounded-xl
           border border-gray-200 text-gray-400
           cursor-not-allowed font-medium"
  >
    PDF Not Available
  </button>
)}

            </div>
          </div>
        </div>
      </section>
    ) : (
      <section class="container mx-auto px-4 py-20 text-center">
        <h1 class="text-2xl font-semibold text-black">
          Product not found
        </h1>
        <p class="mt-2 text-gray-500">
          The product youâ€™re looking for does not exist.
        </p>
      </section>
    )}

    <!-- EXTENDED DETAILS -->
    {product && (
<ProductExtendedDetails
  overview={finalExtendedDetails.overview}
  technical={finalExtendedDetails.technical}
  applications={finalExtendedDetails.applications}
  standards={finalExtendedDetails.standards}
/>

)}


    {product && (
  <ProductInquiryForm 
    productName={product.name}
    productSlug={product.slug}
  />
)}


  </main>
  <Footer/>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const mainImage = document.getElementById("mainImage") as HTMLImageElement | null;
    const thumbs = document.querySelectorAll<HTMLButtonElement>(".thumb");

    if (!mainImage) return;

    thumbs.forEach((btn) => {
      btn.addEventListener("click", () => {
        const src = btn.getAttribute("data-img");
        if (!src) return;

        mainImage.classList.add("opacity-0");

        setTimeout(() => {
          mainImage.src = src;
          mainImage.classList.remove("opacity-0");
        }, 150);
      });
    });
  });
</script>

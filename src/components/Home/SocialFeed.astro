---
const { section } = Astro.props;
if (!section) return;

const { heading = "", subheading = "", items = [] } = section;

function formatDate(date) {
  if (!date) return "";
  return new Date(date).toISOString().slice(0, 10);
}
---

<!-- ================= SOCIAL FEED ================= -->
<section class="w-full py-16 bg-gray-50">
  <div class="container mx-auto px-6">

    <h2 class="text-3xl sm:text-4xl font-medium text-gray-900">
      {heading}
    </h2>
    <p class="text-lg text-gray-700 mt-1">
      {subheading}
    </p>

    <swiper-container
      slides-per-view="1"
      space-between="16"
      breakpoints='{"640":{"slidesPerView":2},"1024":{"slidesPerView":4}}'
      class="mt-10"
      loop="true"
      autoplay-delay="2000"
      speed="800"
    >
      {items.map((item, index) => (
        <swiper-slide>
          <div class="bg-white rounded-3xl shadow-sm overflow-hidden mb-10">

            <!-- MEDIA (ONLY THIS OPENS MODAL) -->
            <button
  type="button"
  class="media-trigger relative aspect-[4/5] w-full bg-gray-100 overflow-hidden"
  data-index={index}
  data-type={item.type}
  data-title={item.title}
  data-date={formatDate(item.date)}
  data-description={item.description}
  data-image={
    item.image?.asset?.url ||
    item.thumbnail?.asset?.url
  }
  data-video={item.video?.asset?.url}
  data-instagram={item.instagramUrl}
>
  <img
    src={
      item.image?.asset?.url ||
      item.thumbnail?.asset?.url ||
      "/images/placeholder.png"
    }
    class="w-full h-full object-cover hover:scale-105 transition"
    alt={item.title}
  />

  {item.type === "reel" && (
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="bg-white/90 rounded-full px-5 py-3 text-lg">▶</div>
    </div>
  )}
</button>


            <!-- CONTENT -->
            <div class="p-4 space-y-3">
              <p class="text-sm text-gray-800 line-clamp-3">
                {item.description}
              </p>

              <div class="flex items-center justify-between">
                <a
                  href={item.instagramUrl}
                  target="_blank"
                  rel="noopener"
                >
                  <img
                    src="/icons/64px-Instagram_logo_2022.svg.png"
                    class="w-6 h-6"
                    alt="Instagram"
                  />
                </a>

                <span class="text-xs text-gray-500">
  {formatDate(item.date)}
</span>

              </div>
            </div>

          </div>
        </swiper-slide>
      ))}
    </swiper-container>
  </div>
</section>

<!-- ================= MODAL ================= -->
<div
  id="socialModal"
  class="fixed inset-0 bg-black/70 hidden z-50
         flex items-center justify-center px-4"
>
  <div class="relative bg-white rounded-2xl max-w-[1000px] w-full
              grid md:grid-cols-[360px_1fr] gap-6 p-6">

    <button id="closeModal"
      class="absolute top-4 right-4 w-10 h-10 rounded-full bg-black/60 text-white">
      ✕
    </button>

    <div class="flex justify-center">
      <div class="aspect-[4/5] w-full max-w-[360px] bg-black rounded-xl overflow-hidden">
        <video id="modalVideo" controls class="hidden w-full h-full"></video>
        <img id="modalImage" class="hidden w-full h-full object-contain bg-white" />
      </div>
    </div>

    <div>
      <h3 id="modalTitle" class="text-xl font-semibold"></h3>
      <p id="modalDate" class="text-xs text-gray-400 mt-1"></p>
      <p id="modalDescription" class="mt-3 text-gray-700"></p>

      <a
        id="modalInstagram"
        target="_blank"
        rel="noopener"
        class="inline-block mt-5 px-5 py-2.5 rounded-full
               bg-gradient-to-r from-pink-500 to-orange-500
               text-white text-sm font-medium"
      >
        View on Instagram
      </a>

      <div class="flex gap-3 mt-6">
        <button id="prevModal" class="px-4 py-2 bg-gray-200 rounded-full">Prev</button>
        <button id="nextModal" class="px-4 py-2 bg-gray-200 rounded-full">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
  const modal = document.getElementById("socialModal");
  const video = document.getElementById("modalVideo");
  const image = document.getElementById("modalImage");
  const title = document.getElementById("modalTitle");
  const date = document.getElementById("modalDate");
  const desc = document.getElementById("modalDescription");
  const instaBtn = document.getElementById("modalInstagram");

  const triggers = Array.from(document.querySelectorAll(".media-trigger"));
  let currentIndex = 0;

  function openModal(index) {
    const el = triggers[index];
    modal.classList.remove("hidden");
    currentIndex = index;

    title.textContent = el.dataset.title;
    date.textContent = el.dataset.date;
    desc.textContent = el.dataset.description;
    instaBtn.href = el.dataset.instagram;

    if (el.dataset.type === "reel") {
      image.classList.add("hidden");
      video.classList.remove("hidden");
      video.src = el.dataset.video;
      video.play();
    } else {
      video.pause();
      video.src = "";
      video.classList.add("hidden");
      image.src = el.dataset.image;
      image.classList.remove("hidden");
    }
  }

  triggers.forEach((el, i) =>
    el.addEventListener("click", e => {
      e.stopPropagation();
      openModal(i);
    })
  );

  document.getElementById("closeModal").onclick = () => {
    modal.classList.add("hidden");
    video.pause();
    video.src = "";
  };

  document.getElementById("nextModal").onclick = () =>
    openModal((currentIndex + 1) % triggers.length);

  document.getElementById("prevModal").onclick = () =>
    openModal((currentIndex - 1 + triggers.length) % triggers.length);
</script>

---
const { slides = [] } = Astro.props;

const styleMap = {
  light: {
    eyebrow: 'text-red-600',
    heading: 'text-black',
    description: 'text-gray-700',
    highlight: 'text-red-600',
    ctaWeight: 'font-medium',
    ctaShadow: 'shadow-red-600/20 hover:shadow-red-600/40'
  },
  dark: {
    eyebrow: 'text-white',
    heading: 'text-white',
    description: 'text-gray-200',
    highlight: 'text-white',
    ctaWeight: 'font-semibold',
    ctaShadow: 'shadow-red-600/30 hover:shadow-red-600/50'
  }
};
---

<swiper-container
  class="heroSwiper-main w-full h-125 sm:h-125 lg:h-150 xl:h-180 relative"
  loop="true"
  autoplay-delay="4500"
  autoplay-disable-on-interaction="false"
  speed="900"
  effect="fade"
>  <!-- Slide 1 -->
{slides.map((slide) => {
  const variant = slide.variant === 'dark' ? 'dark' : 'light';
  const styles = styleMap[variant];

  return (
    <swiper-slide
      class="flex items-center justify-center sm:justify-start text-white bg-cover bg-center relative"
      style={`background-image: url(${slide.backgroundImage?.asset?.url})`}
    >
      <div class="container mx-auto px-4 sm:px-6 md:px-12">
        <div class="max-w-2xl space-y-4 sm:space-y-6">

          <span
            class={`inline-block text-[11px] sm:text-xs tracking-[0.25em] uppercase font-semibold ${styles.eyebrow}`}
          >
            {slide.eyebrow}
          </span>

          <h1
            class={`text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-extrabold leading-tight ${styles.heading}`}
          >
            {slide.heading}{' '}
            {slide.highlight && (
              <span class={styles.highlight}>{slide.highlight}</span>
            )}
          </h1>

          <p
            class={`text-base sm:text-lg leading-relaxed max-w-lg ${styles.description}`}
          >
            {slide.description}
          </p>

          <div class="pt-3">
            <a
  href={slide.ctaLink}
  class={`group inline-flex items-center
    h-12
    pl-6 pr-1
    rounded-full
    bg-red-600 text-white
    text-sm sm:text-base
    ${styles.ctaWeight}
    transition-all duration-300
    hover:bg-red-700
    shadow-lg
    ${styles.ctaShadow}`}
>
  <!-- TEXT -->
  <span class="mr-4">
    {slide.ctaLabel}
  </span>

  <!-- ARROW WRAPPER (PERFECT INSET) -->
  <span
    class="flex items-center justify-center
           w-10 h-10
           rounded-full
           bg-white"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="w-5 h-5 text-red-600"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M5 12h14M13 5l7 7-7 7" />
    </svg>
  </span>
</a>

          </div>

        </div>
      </div>
    </swiper-slide>
  );
})}




<!-- Progress Bars -->
<div class="absolute z-50 bottom-6 sm:bottom-8 md:bottom-10 left-0 w-full">
  <div class="container mx-auto px-4 sm:px-6 md:px-12">

    <div class="flex items-center gap-2 sm:gap-3">

      <!-- BAR -->
      <div class="relative w-16 sm:w-20 md:w-24 lg:w-40">
        <div class="absolute inset-0 h-1.5 bg-white/20 rounded-full"></div>
        <div
          class="heroSwiper-progress h-1.5 bg-white rounded-full scale-x-0"
          style="transform-origin:left; will-change:transform;"
        ></div>
      </div>

      <!-- BAR -->
      <div class="relative w-16 sm:w-20 md:w-24 lg:w-40">
        <div class="absolute inset-0 h-1.5 bg-white/20 rounded-full"></div>
        <div
          class="heroSwiper-progress h-1.5 bg-white rounded-full scale-x-0"
          style="transform-origin:left; will-change:transform;"
        ></div>
      </div>

      <!-- BAR -->
      <div class="relative w-16 sm:w-20 md:w-24 lg:w-40">
        <div class="absolute inset-0 h-1.5 bg-white/20 rounded-full"></div>
        <div
          class="heroSwiper-progress h-1.5 bg-white rounded-full scale-x-0"
          style="transform-origin:left; will-change:transform;"
        ></div>
      </div>

    </div>
  </div>
</div>



<!-- Custom Controls -->
<div class="absolute bottom-4 sm:bottom-6 md:bottom-10 left-0 w-full z-50">
  <div class="container mx-auto px-4 sm:px-6 md:px-12 flex items-center justify-end">

    <!-- Controls -->
    <div
      class="flex items-center gap-1 sm:gap-2
             rounded-full
             bg-white/10 backdrop-blur-md
             border border-white/20
             px-2 sm:px-3 py-1.5
             shadow-lg shadow-black/30"
             >

      <!-- Prev -->
      <button
        class="heroSwiper-prevBtn
               w-5 h-5
               flex items-center justify-center
               rounded-full
               text-black text-base sm:text-lg
               transition-all duration-300"
        aria-label="Previous slide"
      >
        ‚ùÆ
      </button>

      <!-- Autoplay -->
      <button
        class="heroSwiper-autoplayControl
               w-5 h-5
               flex items-center justify-center
               rounded-full

               transition-all duration-300"
        aria-label="Pause autoplay"
      >
      </button>

      <!-- Next -->
      <button
        class="heroSwiper-nextBtn
               w-5 h-5
               flex items-center justify-center
               rounded-full
               text-black text-base sm:text-lg
               transition-all duration-300"
        aria-label="Next slide"
      >
        ‚ùØ
      </button>

    </div>

  </div>
</div>

</swiper-container>


<style>
  /* Prevent swiper stacking flash */
swiper-container:not(.swiper-initialized) {
  visibility: hidden;
}

swiper-container.swiper-initialized {
  visibility: visible;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const swiperEl = document.querySelector('.heroSwiper-main');
  if (!swiperEl) return;

  // When Swiper initializes
  swiperEl.addEventListener('swiperinit', () => {
    swiperEl.classList.add('swiper-initialized');
  });

  // Fallback (in case event fires early)
  if (swiperEl.swiper) {
    swiperEl.classList.add('swiper-initialized');
  }
});
</script>


<script>
import {gsap} from 'gsap';

document.addEventListener('DOMContentLoaded', () => {
  const swiperEl = document.querySelector('.heroSwiper-main') as any;
  const progressBars = document.querySelectorAll(".heroSwiper-progress");
  let activeTween: any = null;

  console.log('DOM loaded - found bars:', progressBars.length);

  // üî• FUNCTION ‚Äî Animate progress for a slide
  function animateProgress(index: number, duration: number) {
    console.log('Animating bar:', index, 'Duration:', duration);
    
    // Reset all progress bars to scaleX 0 (backgrounds stay visible)
    progressBars.forEach((bar: any) => {
      gsap.set(bar, { 
        scaleX: 0, 
        transformOrigin: "left"
      });
    });

    // Kill previous tween
    if (activeTween) activeTween.kill();

    // Animate current bar from 0 to 1
    activeTween = gsap.to(progressBars[index], {
      scaleX: 1,
      ease: "none",
      duration: duration / 1000,
      onComplete: () => {
        console.log('Animation complete');
      }
    });
  }

  // Function to setup swiper listeners
  function setupSwiperListeners(swiper: any) {
    console.log('Setting up swiper listeners, autoplay delay:', swiper.params.autoplay.delay);
    animateProgress(swiper.realIndex, swiper.params.autoplay.delay);

    // On slide change animate new bar
    swiper.on('slideChange', () => {
      console.log('Slide changed to:', swiper.realIndex);
      animateProgress(swiper.realIndex, swiper.params.autoplay.delay);
    });

    // Pause GSAP when autoplay stops
    swiper.on('autoplayStop', () => {
      console.log('Autoplay stopped');
      if (activeTween) activeTween.pause();
    });

    // Resume GSAP when autoplay restarts
    swiper.on('autoplayStart', () => {
      console.log('Autoplay started');
      if (activeTween) activeTween.resume();
    });
  }

  // Try to get swiper immediately (in case it's already initialized)
  if (swiperEl?.swiper) {
    console.log('Swiper already initialized');
    setupSwiperListeners(swiperEl.swiper);
  } else {
    // Wait for swiper to initialize
    swiperEl?.addEventListener('swiperinit', () => {
      console.log('Swiper init event fired');
      setupSwiperListeners(swiperEl.swiper);
    }, { once: true });

    // Fallback: check after 1 second if swiper exists
    setTimeout(() => {
      if (swiperEl?.swiper && !activeTween) {
        console.log('Swiper found via timeout');
        setupSwiperListeners(swiperEl.swiper);
      }
    }, 1000);
  }
});
</script>

<!-- Swiper Control Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const swiperEl = document.querySelector('.heroSwiper-main');
  const nextBtn = document.querySelector('.heroSwiper-nextBtn');
  const prevBtn = document.querySelector('.heroSwiper-prevBtn');
  const controlBtn = document.querySelector('.heroSwiper-autoplayControl');

  if (!swiperEl || !controlBtn) return;

  // Navigation
  nextBtn?.addEventListener('click', () => swiperEl.swiper.slideNext());
  prevBtn?.addEventListener('click', () => swiperEl.swiper.slidePrev());

  // SVG templates (BLACK icons)
  const playIcon = `
    <svg width="16" height="16" viewBox="0 0 16 16"
      xmlns="http://www.w3.org/2000/svg">
      <path
        d="M11.5708 8.85749C12.2182 8.46909 12.2182 7.53091 11.5708 7.14251L4.5145 2.9087C3.84797 2.50878 3 2.9889 3 3.76619V12.2338C3 13.0111 3.84797 13.4912 4.5145 13.0913L11.5708 8.85749Z"
        fill="#000000"
      />
    </svg>
  `;

  const pauseIcon = `
    <svg width="16" height="16" viewBox="0 0 16 16"
      xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="2" width="3" height="12" fill="#000000"/>
      <rect x="10" y="2" width="3" height="12" fill="#000000"/>
    </svg>
  `;

  // üî• INITIAL STATE SYNC (THIS IS THE FIX)
  const updateIcon = () => {
    controlBtn.innerHTML = swiperEl.swiper.autoplay.running
      ? pauseIcon   // autoplay ON ‚Üí show pause
      : playIcon;   // autoplay OFF ‚Üí show play
  };

  // Set correct icon on load
  updateIcon();

  // Play / Pause toggle
  controlBtn.addEventListener('click', () => {
    if (swiperEl.swiper.autoplay.running) {
      swiperEl.swiper.autoplay.stop();
    } else {
      swiperEl.swiper.autoplay.start();
    }
    updateIcon();
  });
});
</script>
